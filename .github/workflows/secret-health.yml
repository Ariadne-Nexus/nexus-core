name: Secret Health

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - ".github/workflows/**"
  schedule:
    - cron: "0 12 * * *"  # Daily at 12:00 UTC (4:00 AM PT / 7:00 AM ET)

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    permissions: {}  # No special permissions needed
    env:
      # Add any others on new lines (e.g., GITHUB_APP_ID, STRIPE_SECRET, etc.)
      REQUIRED_SECRETS: |
        OPENAI_API_KEY

    steps:
      - name: Validate required secrets (masked)
        env:
          # Map each required secret here:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Add more secrets as needed:
          # GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          # STRIPE_SECRET: ${{ secrets.STRIPE_SECRET }}
        run: |
          echo "Checking required secrets..."
          missing=0
          for name in $REQUIRED_SECRETS; do
            val="${!name}"
            if [ -z "$val" ] || [[ "$val" == "your-openai-api-key-here" ]]; then
              echo "::error title=Secret missing::Required secret '$name' is not set or is a placeholder."
              missing=1
            else
              echo "✓ $name present (value masked in logs)"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            echo ""
            echo "::error::One or more required secrets are missing or misconfigured."
            echo "Add them at: https://github.com/dotlink-ops/Avidelta/settings/secrets/actions"
            exit 1
          fi
          
          echo ""
          echo "✅ All required secrets validated successfully"
      
      - name: Summary
        if: success()
        run: |
          echo "### ✅ Secret Health Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required secrets are configured correctly." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checked secrets:**" >> $GITHUB_STEP_SUMMARY
          for name in $REQUIRED_SECRETS; do
            echo "- ✓ $name" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Last checked: $(date -u +"%Y-%m-%d %H:%M UTC")_" >> $GITHUB_STEP_SUMMARY

  # Optional: Environment-specific secret validation (staging)
  check-secrets-staging:
    runs-on: ubuntu-latest
    # Uncomment to enable staging environment checks:
    # environment: staging
    if: false  # Set to true to enable
    permissions: {}
    env:
      REQUIRED_SECRETS: |
        OPENAI_API_KEY

    steps:
      - name: Validate staging secrets (masked)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Checking staging environment secrets..."
          missing=0
          for name in $REQUIRED_SECRETS; do
            val="${!name}"
            if [ -z "$val" ]; then
              echo "::error title=Staging secret missing::Required secret '$name' is not set in staging environment."
              missing=1
            else
              echo "✓ $name present in staging (value masked)"
            fi
          done
          exit $missing

  # Optional: Environment-specific secret validation (production)
  check-secrets-production:
    runs-on: ubuntu-latest
    # Uncomment to enable production environment checks:
    # environment: production
    if: false  # Set to true to enable
    permissions: {}
    env:
      REQUIRED_SECRETS: |
        OPENAI_API_KEY

    steps:
      - name: Validate production secrets (masked)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Checking production environment secrets..."
          missing=0
          for name in $REQUIRED_SECRETS; do
            val="${!name}"
            if [ -z "$val" ]; then
              echo "::error title=Production secret missing::Required secret '$name' is not set in production environment."
              missing=1
            else
              echo "✓ $name present in production (value masked)"
            fi
          done
          exit $missing
